---
title: Node.js åƒåœ¾å›æ”¶
date: 2018-04-22 16:02:30
tags: [Node.js, ç›‘æ§, é¢è¯•]
author: xizhibei
issue_link: https://github.com/xizhibei/blog/issues/75
---
<!-- en_title: nodejs-garbage-collection -->

è¯è¯´ï¼Œåœ¨å¾ˆä¹…ä»¥å‰çš„ç¨‹åºç•Œï¼Œæ˜¯æ²¡æœ‰å†…å­˜åƒåœ¾å›æ”¶è¿™ç§è¯´æ³•çš„ï¼Œå¤§å®¶ä¹ æƒ¯äºè¢« C ä»¥åŠ C++ çš„å†…å­˜é—®é¢˜å„ç§èŠ±å¼åŠæ‰“ã€‚

ç›´åˆ°æœ‰ä¸€å¤©ï¼ŒJohn McCarthy å¤§ç¥ 1959 å¹´åœ¨ LISP ä¸­å®ç°äº†å†…å­˜åƒåœ¾å›æ”¶ï¼Œå¤§å®¶æ‰æƒŠå¥‡çš„åœ°å‘ç°ï¼šã€å±…ç„¶è¿˜æœ‰è¿™ç§æ“ä½œï¼Ÿã€ã€‚
æ­£å¦‚ iPhone å‡ºæ¥ä¹‹åé‡æ–°å®šä¹‰äº†æ‰‹æœºï¼Œå†…å­˜åƒåœ¾å›æ”¶çš„å‡ºç°æ— å¼‚äºé‡æ–°å®šä¹‰äº†é«˜çº§è¯­è¨€ã€‚

å¥½ï¼Œæ¥ä¸‹æ¥å¼€å§‹èŠèŠ Node.js é‡Œé¢çš„ GCã€‚
### Nodejs GC
ç½‘ä¸Šå„ç§æ–‡ç« éƒ½ä¼šå‘Šè¯‰ä½  Node.js ä¸­ç±»ä¼¼äºä¸‹é¢çš„è¿™ç§å†…å­˜åƒåœ¾å›æ”¶åŸç† [1][3]ï¼š

> åœ¨ Node ä¸­ï¼Œå†…å­˜æ˜¯ v8 è´Ÿè´£ç®¡ç†çš„ï¼Œè€Œåœ¨ç¨‹åºçš„ heap ç©ºé—´ä¸­ï¼Œä¸»è¦åˆ†ä¸º New Space ä¸ Old Spaceã€‚ä¸€èˆ¬åœ¨ New Space ä¸­çš„è¢«ç§°ä¸ºæ–°ç”Ÿä»£ï¼Œå¤§æ¦‚æœ‰ 1-8 MB å¤§å°ï¼Œå¤§å¤šæ•°çš„å†…å­˜åˆ†é…éƒ½æ˜¯åœ¨è¿™é‡Œï¼ŒæŒ‰ç…§ç»Ÿè®¡æ¥è¯´ï¼Œå¤§çº¦ 80% çš„å†…å­˜åƒåœ¾éƒ½ä¼šè¢«å›æ”¶æ‰ï¼Œè€Œæ²¡æœ‰è¢«å›æ”¶æ‰çš„åˆ™è¿›å…¥äº† Old Space ä¸­ï¼Œè¢«ç§°ä¸ºè€ç”Ÿä»£æ•°æ®ï¼Œè¿™é‡Œé¢çš„æ•°æ®å¤§å°é™åˆ¶ä¸º ~0.7GBï¼ˆ32 ä½æœºå™¨ï¼‰ä»¥åŠ ~1.4GB ï¼ˆ64 ä½æœºå™¨ï¼‰ã€‚
> è‡³äºå›æ”¶æ–¹å¼ï¼Œæœå¯»ï¼ˆScavengeï¼‰æ¸…é™¤æ³•ï¼Œå¿«ï¼Œä½œç”¨äºæ–°ç”Ÿä»£ï¼›è€Œæ ‡è®°æ¸…é™¤æ³•ï¼ˆMark-Sweepï¼‰ã€æ ‡è®°æ•´ç† (Mark-Compact)ã€å¢é‡æ ‡è®°ï¼ˆIncremental Markingï¼‰ç›¸å¯¹æ¥è¯´æ…¢ï¼Œä½œç”¨äºè€ç”Ÿä»£ã€‚
> æ— è®ºå“ªç§å›æ”¶ï¼Œéƒ½ä¼šäº§ç”Ÿ ã€stop-the-worldã€ ç°è±¡ï¼Œä¹Ÿå°±æ˜¯åœæ­¢å…¶å®ƒä»£ç æ‰§è¡Œï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´æ—¶é—´å¤ŸçŸ­ï¼Œä¸ä¼šè®©ä½ æ˜æ˜¾å¯Ÿè§‰åˆ°ã€‚
> Node åœ¨æœåŠ¡ç«¯å¾ˆå®¹æ˜“æœ‰å¤§å†…å­˜ï¼Œå› æ­¤ v8 åœ¨ä¹‹åå¼•å…¥çš„å¢é‡æ ‡è®°ï¼ˆIncremental Markingï¼‰æ–¹å¼ï¼ŒæŠŠæ ‡è®°åˆ†æ®µæ‰§è¡Œï¼Œæ¯ä¸€æ®µéƒ½æ§åˆ¶åœ¨ 5ms å·¦å³ï¼Œå°½é‡é¿å…å½±å“åˆ°ç¨‹åºæ‰§è¡Œã€‚

ä¸‹é¢è¯´ä¸‹ä¸æ­¤éå¸¸ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼š

1. å½“å†…å­˜ä½¿ç”¨ä¸Šå‡è¿‡å¿«æ¥ä¸åŠè¢«å›æ”¶ï¼Œæˆ–è€…æ ¹æœ¬æ— æ³•è¢«å›æ”¶çš„æ—¶å€™ï¼ŒNode.js å®¹æ˜“å‡ºç°å´©æºƒç°è±¡ï¼ˆOOMï¼Œå³ Out of memoryï¼‰ï¼Œè¿™æ—¶å€™å¯ä»¥è°ƒæ•´ node çš„å‚æ•° `--max-old-space-size`ï¼Œå•ä½æ˜¯ MBã€‚
2. Buffer æ—¢ä¸æ˜¯åœ¨ New Space ä¹Ÿä¸æ˜¯åœ¨ Old Spaceï¼Œè€Œæ˜¯åœ¨ Node çš„ C++ å±‚é¢ç”³è¯·çš„ï¼Œå¤§å°ä¸å— v8 çš„é™åˆ¶ã€‚

### å†…å­˜æ³„éœ²
GC å†å¥½ï¼Œä¹Ÿä¼šæœ‰å®ƒçš„å‰¯ä½œç”¨ï¼Œæ¯”å¦‚å†…å­˜æ³„éœ²ï¼ŒNode.js å¦‚æœä½¿ç”¨äº†é—­åŒ…ï¼Œä¸€ä¸å°å¿ƒå°±å¾ˆå®¹æ˜“å‡ºç°å†…å­˜æ³„éœ²ï¼Œä¸‹é¢çš„ä»£ç æ¥è‡ª [1][2]ï¼š

```js
var theThing = null
var replaceThing = function () {
  var originalThing = theThing
  var unused = function () {
    if (originalThing)
      console.log("hi")
  }
  theThing = {
    longStr: new Array(1000000).join('*'),
    someMethod: function () {
      console.log(someMessage)
    }
  };
};
setInterval(replaceThing, 1000)
```

æ¯è¿‡ä¸€ç§’é’Ÿï¼Œ`theThing` å°±ä¼šè¢«è¦†ç›–ï¼Œä½†æ˜¯ `unused` å´å¤„äº `someMethod` çš„é—­åŒ… context å†…ï¼Œå› æ­¤å³ä½¿å®ƒæ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼Œå®ƒä¹Ÿä¼šé˜»æ­¢å®ƒé‡Œé¢åŒ…å«çš„ `originalThing` è¢«å›æ”¶ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„å¼•ç”¨é“¾ï¼š`someMethod` -> `unused` -> `originalThing` -> `theThing`ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨åï¼Œ`theThing` å˜æˆäº†ä¸€ä¸ªé—­åŒ…ï¼Œå¹¶ä¸”æ˜¯å…¨å±€å˜é‡è€Œä¸ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥å½“å†æ¬¡æ‰§è¡Œåï¼Œåˆä¼šæœ‰æ–°çš„éƒ¨åˆ†åŠ åˆ°è¿™ä¸ªå¼•ç”¨é“¾ä¸Šã€‚å› è€Œæ¯æ¬¡ `replaceThing` è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½ä¼šè®©è¿™ä¸ªå¼•ç”¨é“¾å˜çš„æ›´é•¿ï¼Œç”±æ­¤é€ æˆäº†å†…å­˜ä¸æ–­æ³„éœ²ã€‚

æ€ä¹ˆæ‰¾å‡ºè¿™ç§é—®é¢˜ï¼Ÿæˆ‘ä¹‹å‰åœ¨ [Node.js æ€§èƒ½åˆ†æä¹‹ç«ç„°å›¾](https://github.com/xizhibei/blog/issues/57) ä¸­ä¹Ÿæåˆ°è¿‡ï¼Œç”¨ heapdump æˆ–è€… v8-profiler éƒ½èƒ½å®ç°ã€‚

### ç›‘æ§
å¥½äº†ï¼Œé‚£ä¹ˆåœ¨å¹³æ—¶çš„è¿ç»´ä¸­å¦‚ä½•åŠæ—¶å‘ç°ä»¥åŠå®šä½è¿™ç§é—®é¢˜ï¼Ÿ

å¾ˆæ˜¾ç„¶ï¼Œä½ éœ€è¦ä¸€äº› v8 å†…å­˜çš„æŒ‡æ ‡ï¼Œä¸€ä¸ªæ˜¯ node è‡ªå¸¦çš„ `process.memoryUsage()`ï¼Œå¦ä¸€ä¸ªæ˜¯ gc æ•°æ®ï¼Œå¯ä»¥çœ‹çœ‹ node v8 å‚æ•°é‡Œä¸ gc ç›¸å…³çš„å‚æ•°ï¼š `node --v8-options | grep gc`ã€‚

å¦å¤–è¿˜æœ‰ä¸ªæŒºæœ‰ç”¨çš„æ¨¡å—ï¼š [gcstats](https://github.com/dainis/node-gcstats)ï¼Œå®ƒç”¨ C++ å®ç°äº† v8 å±‚é¢çš„ gc ç›‘æ§ã€‚

å‡å¦‚ä½ ç”¨çš„æ˜¯ prometheusï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å—ï¼š[node-prometheus-gc-stats](https://github.com/SimenB/node-prometheus-gc-stats)ã€‚

### é¢è¯•
æˆ‘ä»¬åœ¨é¢è¯•ä¸­ï¼Œæœ‰æ—¶å€™ä¼šç»™å‡ºè¿™æ ·çš„åœºæ™¯é¢˜ï¼š

> ç»™ä½ ä¸€å° 1 æ ¸ 1 G çš„æœºå™¨ï¼Œå¦‚ä½•ä¸åˆ©ç”¨æ•°æ®åº“æœ¬èº«çš„èšåˆåŠŸèƒ½æ¥å®ç°ä¸€ä¸ªå«æœ‰ä¸€äº¿è¡Œæ•°æ®çš„ç®€å•ç»Ÿè®¡ï¼Œå¦‚æ±‚å’Œï¼Ÿ

è¿™é“é¢˜å…¶ä¸­å°±å¾ˆè€ƒéªŒå¯¹ Node.js çš„ç†è§£ä»¥åŠç»éªŒäº†ï¼Œå‡å¦‚å€™é€‰äººæåˆ°äº† stream æ¨¡å—ï¼Œé‚£åŸºæœ¬ä¸Šå°±ç®—ç­”å¯¹äº†ã€‚

åªæ˜¯ï¼Œå‡å¦‚ä½ æŠŠæ€è€ƒè¿‡ç¨‹è¯´ç»™é¢è¯•å®˜å¬çš„è¯ï¼Œæ•ˆæœä¼šæ›´å¥½ï¼š

> æ¯”å¦‚é—®æ¸…æ¯è¡Œæ•°æ®å¤§å°ï¼ˆä¸ç»™çš„è¯å°±è‡ªå·±ä¼°è®¡ï¼‰ï¼Œä¸€äº¿è¡Œæ•°æ®ï¼ŒæŒ‰å°äº†å‡è®¾ï¼Œæ¯è¡Œæ•°æ®åœ¨å†…å­˜ä¸­æœ‰ 100 bytes å¤§å°ï¼Œé‚£ä¹ˆä¸€äº¿å¤§æ¦‚éœ€è¦ 10G å†…å­˜ï¼Œæ˜¾ç„¶è¿™å°æœºå™¨çš„å†…å­˜ä¸å¤Ÿç”¨ã€‚
> å¦‚æœåˆ†æˆ 10~20 æ¬¡è®¡ç®—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåªæ˜¯è¿™æ ·ä¼šé€ æˆæ•°æ®åº“ç¿»é¡µå–æ•°æ®çš„æ€§èƒ½é—®é¢˜ä»¥åŠ Node.js æœ¬èº«åƒåœ¾å›æ”¶çš„é—®é¢˜ï¼Œå› ä¸ºè¿™äº›æ•°æ®å¾ˆå¤§ä¼šè¢«æ”¾åœ¨è€ç”Ÿä»£ï¼Œå›æ”¶å¾ˆæ…¢ï¼Œå¯¼è‡´è®¡ç®—ä¹Ÿéå¸¸æ…¢ã€‚
> å› æ­¤å¯ä»¥è€ƒè™‘ç”¨ Node.js çš„ stream æ¨¡å—ï¼Œä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜ï¼Œå¤„ç†å¥½çš„è¯å¤§éƒ¨åˆ†æ•°æ®éƒ½ä¼šåœ¨æ–°ç”Ÿä»£ä¸­è¢«å›æ”¶æ‰ï¼Œå¹¶ä¸”å¯¹äºæ•°æ®åº“æ¥è¯´ï¼Œä¸€æ¬¡æ€§åœ°æŒç»­å–å‡ºä¹Ÿä¸ä¼šå¯¹æ•°æ®åº“é€ æˆç¿»é¡µçš„é—®é¢˜ï¼Œè®¡ç®—é€Ÿåº¦ä¹Ÿåº”è¯¥æ¯”å‰ä¸€ç§æ–¹æ³•å¿«ã€‚

çœ‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ è‡³å°‘å±•ç¤ºäº†ä½ è§£å†³é—®é¢˜çš„èƒ½åŠ›ã€è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›ã€å¯¹ Node.js å†…å­˜åƒåœ¾å›æ”¶çš„æ·±åˆ»ç†è§£ä»¥åŠåœ¨æ•°æ®åº“æ€§èƒ½è°ƒä¼˜æ–¹é¢çš„ç»éªŒã€‚

é¢è¯•å®˜ä¼šè‚¯å®šç»™ä½  ğŸ’¯ çš„ã€‚

### Ref
[1]: [Node.js Garbage Collection Explained](https://blog.risingstack.com/node-js-at-scale-node-js-garbage-collection/)
[2]: [Understanding Garbage Collection and Hunting Memory Leaks in Node.js](https://blog.codeship.com/understanding-garbage-collection-in-node-js/)
[3]: [æ·±å…¥ç†è§£ Node.js åƒåœ¾å›æ”¶ä¸å†…å­˜ç®¡ç†](https://www.jianshu.com/p/4129a3fce7bb)



***
é¦–å‘äº Github issues: https://github.com/xizhibei/blog/issues/75 ï¼Œæ¬¢è¿ Star ä»¥åŠ Watch

{% post_link footer %}
***