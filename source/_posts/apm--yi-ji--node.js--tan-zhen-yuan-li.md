---
title: APM ä»¥åŠ Node.js æ¢é’ˆåŸç†
date: 2017-02-18 22:34:34
tags: [Node.js]
author: xizhibei
---
### å…³äº APM

APM èƒ½å¸®ä¼ä¸šä»¥åŠåº”ç”¨å¼€å‘è€…æä¾›å¾ˆå¤šå¸®åŠ©ï¼Œå®ƒçš„åŠŸèƒ½é›†ä¸­åœ¨ç›‘æ§ã€åˆ†æã€ä¼˜åŒ–ä¸Šé¢ï¼Œä»åº”ç”¨ä¸­éƒ¨ç½²æ¢é’ˆç›´æ¥é‡‡é›†ä¿¡æ¯ï¼Œé›†ä¸­å¤„ç†ï¼Œä»å¤šç»´åº¦å½¢æˆæŠ¥å‘Šï¼Œç®€è€Œè¨€ä¹‹ï¼š** ç›¸å½“äºç»™äº†ä¸€å‰¯çœ‹åˆ°åº”ç”¨ç¨‹åºä¸è¶³çš„çœ¼é•œ **ã€‚

å¤šä½™çš„ä¸å†èµ˜è¿°ï¼Œå¯ä»¥çœ‹æ–‡æœ«å‚è€ƒé“¾æ¥ã€‚

### å‡ ä¸ªé€‰æ‹©
ç›®å‰å‡ ä¸ªå¥½ç”¨çš„ï¼Œå¹¶ä¸”æ”¯æŒ Node.js åº”ç”¨çš„:

- NewRelic
- OneAPM
- Tingyun

ä»å¥½ç”¨ç¨‹åº¦æ¥è¯´ï¼ŒNewRelic ç§’æ€å…¨éƒ¨ï¼Œåªæ˜¯å›½å†…çš„ APM å…¶å®ä¹Ÿå‘å±•èµ·æ¥äº†ï¼Œæœ‰ç€æœ¬åœ°åŒ–çš„ä¼˜åŠ¿ï¼Œèƒ½ç»™å›½å†…ä¼ä¸šä¸€äº›æœ¬åœ°åŒ–çš„è§£å†³æ–¹æ¡ˆï¼ŒNewRelic å¤©é«˜çš‡å¸è¿œï¼Œä¹Ÿæ˜¯æœ‰ç€è¿™æ–¹é¢çš„å¼Šç«¯çš„ã€‚

ç›®å‰æˆ‘ä»¬çš„æœåŠ¡å™¨ç«¯ç›‘æ§ç”¨çš„ NewRelicï¼Œé€‰æ‹©åŸå› ä¸»è¦æ˜¯å¼ºå¤§ã€é€Ÿåº¦å¿«ã€ç»†èŠ‚æ¸…æ¥šã€‚è€Œæ‰‹æœºä¸Š APP çš„ APM é€‰æ‹©çš„ Tingyunï¼Œå› ä¸ºå®ƒæœ¬åœ°åŒ–ä¼˜åŠ¿å¾ˆæ˜æ˜¾ã€‚

é€‰æ‹©çš„æ—¶å€™ä¸å¦¨å¤šè¯•ç”¨æ¯”è¾ƒï¼Œä»è‡ªèº«éœ€æ±‚å‡ºå‘å»è€ƒå¯Ÿä¸ç­›é€‰ã€‚

å¥½äº†ï¼Œéå¸¸ç®€å•çš„ä»‹ç»äº†ä¸‹ï¼Œä¸éš¾å‘ç°ï¼Œå¯¹äº APM æ¥è¯´ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹åœ¨äºæ•°æ®çš„é‡‡é›†ï¼Œä¹Ÿå°±æ˜¯éœ€è¦éƒ¨ç½²æ¢é’ˆå»é‡‡é›†åº”ç”¨çš„å„é¡¹æ•°æ®ï¼Œé‚£ä¹ˆï¼Œæ¢é’ˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

### Node.js æ¢é’ˆåŸç†
è¯´æ˜ç»†èŠ‚ä¹‹å‰ï¼Œä¸å¦¨æ¥åšä¸ªå°é¢˜ç›®ï¼š** å¦‚ä½•è®°å½•ä¸€ä¸ªå‡½æ•°çš„è¿è¡Œæ—¶é—´ï¼Ÿ**ã€‚

ä¸å–å…³å­ï¼Œå¾ˆç®€å•ï¼Œå†™ä¸ªå‡½æ•°ï¼Œç›´æ¥åŒ…è£…ä¸‹å³å¯ï¼š

```js
function a() {...}

// åŒæ­¥
function b() {
  const start = Date.now();
  a();
  const time = Date.now() - start();
}

// å¼‚æ­¥
function b() {
  const start = Date.now();
  return a()
    .finally(() => {
      const time = Date.now() - start();
    })
}
```

ç°åœ¨ä½ å·²ç»ä¼šåš APM äº†ï¼Œå¯¹çš„ï¼Œä¸æ˜¯å¼€ç©ç¬‘ï¼ŒåŸç†å³æ˜¯å¦‚æ­¤ã€‚

å½“ç„¶äº†ï¼Œå®é™…åšçš„æ—¶å€™ï¼Œä¼šæœ‰å¾ˆå¤šå¤æ‚çš„å®ç°åœ¨é‚£ï¼Œæ¯”å¦‚ï¼Œå¦‚ä½•éä¾µå…¥æ€§åœ°éƒ¨ç½²è¿™ä¸ªæ¢é’ˆï¼Œä»¥åŠå¦‚ä½•åœ¨ä¸€æ¬¡è¯·æ±‚è¿‡ç¨‹é“¾ä¸­è®°å½•å¤šä¸ªè¢«è°ƒç”¨å‡½æ•°çš„ metrics ç­‰ç­‰ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼ŒNode.js ç”±äºå®ƒçš„å¼‚æ­¥åŸç†ï¼Œæ²¡æœ‰å‘æœ‰çº¿ç¨‹æ¨¡å‹çš„åŒæ­¥è¯­è¨€ä¸­çš„ **ã€çº¿ç¨‹æœ¬åœ°å­˜å‚¨ã€**ï¼Œå› æ­¤ä¸æ˜¯èƒ½å¾ˆç®€å•çš„ä¸ä¾µå…¥ä»£ç ï¼Œè€Œåšåˆ°è®°å½•æ¯æ¬¡è¯·æ±‚çš„æ‰€æœ‰è¿‡ç¨‹çš„ï¼Œé‚£ä¹ˆï¼Œç°æœ‰çš„ APM æ¢é’ˆæ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ

é¦–å…ˆå¯ä»¥çœ‹çœ‹è¿™ä¸ªé¡¹ç›®ï¼š[async-listener](https://github.com/othiym23/async-listener)ã€‚

ç®€å•ä»‹ç»ä¸‹ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰çš„ Node.js åŸºç¡€æ¨¡å—ä¸­æ¯ä¸ªå¼‚æ­¥å‡½æ•°ä¸­ callback å‚æ•°åšä¸ªåŒ…è£…ï¼Œå³é’ˆå¯¹ä»¥ä¸‹è¿™å‡ ä¸ªäº‹ä»¶åšæˆ hookï¼Œå°±ç›¸å½“äºä¸€ä¸ª async listener äº†ï¼š

- **create**: è¿›å…¥äº† Node.js çš„äº‹ä»¶é˜Ÿåˆ—ï¼›
- **before**: å‡ºäº†äº‹ä»¶é˜Ÿåˆ—ï¼Œé©¬ä¸Šè¦æ‰§è¡Œä¹‹å‰ï¼›
- **after**: æ‰§è¡Œå®Œæ¯•äº†ï¼›
- **error**: å‡ºé”™ï¼Œæ‰§è¡Œçš„å‡½æ•° throw errorï¼›

ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ `fs.writeFile(file, callback)`ï¼ŒåŒ…è£…ä¹‹åï¼š

```js
fs.writeFile = function wrapWriteFile(file, callback) {
  asyncListener.create();
  process.addListener('uncaughtException', asyncListener.error);
  
  function callbackWrap(err, rst) {
    asyncListener.before();
    callback(err, rst);
    asyncListener.after();
  }
  fs.writeFile(file, (err, content) => {
    callbackWrap(err, content);
  });
}

```

äºæ˜¯æ¯å½“ä¸€ä¸ªå¼‚æ­¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå¯¹åº”çš„ hook éƒ½ä¼šæŠŠç›¸åº”çš„ metrics è®°å½•åˆ°ä¸€ä¸ªä¸“é—¨çš„ storage ä¸­ï¼Œè€Œè¿™ä¸ª storage åœ¨æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ä¸­æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥æœ€åå°±å¯ä»¥å‘é€è‡³ä¸“é—¨çš„å¤„ç†ä¸­å¿ƒå»äº†ã€‚

å¯¹äº†ï¼Œåˆ©ç”¨è¿™ä¸ªåŸç†ï¼Œè¿˜å¯ä»¥åšå¾ˆå¤šæœ‰æ„æ€çš„äº‹æƒ…ï¼Œæ¯”å¦‚ [Continuation-Local Storage](https://github.com/othiym23/node-continuation-local-storage)ã€‚

#### P.S.1
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œasync-listener è¿™ä¸ªé¡¹ç›®åªæ˜¯ä½œä¸ºä¸€ä¸ª monkey patch çš„å­˜åœ¨ï¼Œå®˜æ–¹è‡³ä»Šæ²¡æœ‰å®ç°ï¼Œä»–ä»¬ç»™å‡ºçš„è§£é‡Šä¹Ÿå¾ˆç®€å•ï¼šå®ç°è¿™ä¸ªåŠŸèƒ½éœ€è¦æŸå¤±ä¸€å®šçš„æ€§èƒ½ï¼Œéš¾åº¦æ¯”è¾ƒé«˜ã€‚å›åˆ°æ¢é’ˆä¸Šé¢ï¼Œå…¶å®æ¢é’ˆä¹Ÿä¼šè®©ä½ çš„åº”ç”¨æŸå¤±ä¸€å®šçš„æ€§èƒ½ï¼Œåªæ˜¯è¿™ä¸ªæŸå¤±ä¸ä¼šå¾ˆå¤§ï¼Œè€Œæ¢æ¥çš„æ•ˆæœæ”¶ç›Šç¡®æ˜¯è¿œè¿œé«˜äºè¿™ä¸ªæŸå¤±çš„ã€‚

#### P.S.2
å†æ‰¯ä¸€ç‚¹ï¼Œasync listener åªæ˜¯é’ˆå¯¹æ‰€æœ‰çš„ Node.js åŸºç¡€æ¨¡å—åšäº†åŒ…è£…ï¼Œé‚£ä¹ˆï¼Œå®ƒæ˜¯å¦‚ä½•åœ¨æˆ‘ä»¬è‡ªå·±å®ç°çš„æ¨¡å—ä¸­å…±äº«çš„å‘¢ï¼Ÿ

è¿™æ˜¯åŸºç¡€çŸ¥è¯†ç‚¹ï¼Œç•™ç»™ä½ äº†ã€‚

æç¤ºï¼šNode.js å¼‚æ­¥çš„ç‰¹æ€§æ¥è‡ªäºä½•å¤„ï¼Ÿä¼ æŸ“æ€§æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

### Background Transcation
ä¸Šé¢æåˆ°çš„æ¢é’ˆï¼Œéƒ½æ˜¯ç›´æ¥å¸®ä½ æŠŠæ¯æ¬¡ Web Transcation è®°å½•ä¸‹æ¥ï¼Œé‚£ä¹ˆï¼Œå¦‚ä½•è®°å½•ä¸€äº›ç¦»çº¿ä»»åŠ¡ï¼Ÿ

åŸºæœ¬ä¸Šï¼Œå¦‚æœå®˜æ–¹ä¸æä¾› wrap çš„è¯ï¼Œåªèƒ½è‡ªå·±ä¾µå…¥æ€§çš„éƒ¨ç½²æ¢é’ˆäº†ï¼Œæ¥ä¸‹æ¥ä»¥ NewRelic ä¸ºä¾‹ï¼š

æ–‡æ¡£åœ¨ [è¿™é‡Œ](https://github.com/newrelic/node-newrelic) ï¼Œä¸€å¼€å§‹æ–‡æ¡£é‡Œé¢æ²¡æœ‰å¾ˆæ¸…æ¥šçš„ä½¿ç”¨æ–¹æ³•è¯´æ˜ï¼Œä¹Ÿæ²¡æœ‰å‘ç°å…¶å®ƒç½‘ç«™ä¸Šç°æˆå¯ç›´æ¥å‚è€ƒçš„ä¾‹å­ï¼Œæœ€åæˆ‘è¿˜æ˜¯ä»å®ƒçš„æºç ä¸­å‘ç°äº† [ä¾‹å­](https://github.com/newrelic/node-newrelic/blob/master/examples/api/background-transactions/example4-promises.js)ã€‚

é¦–å…ˆæ˜¯å‡½æ•°å®šä¹‰ï¼š

```js
/*
 * å¼€å§‹ Transcation
 * @param name Transcation name
 * @param [group] Transcation group name, default: NodeJs
 * @param handle è¦è¢«è¿½è¸ªçš„å‡½æ•°
 */
newrelic.createBackgroundTransaction(name, [group], handle)

// ç»“æŸ Transcationï¼Œä¸€å®šéœ€è¦å†ç»“æŸçš„æ—¶å€™è°ƒç”¨ï¼Œä¸ç„¶æ•´ä¸ª Transcation ä¼šè¶…æ—¶
newrelic.endTransaction()
```

ç„¶åæ˜¯ä»¥ [Automattic/kue](https://github.com/Automattic/kue) ä¸ºå…·ä½“çš„ä¾‹å­ï¼š

```js
const newrelic = require('newrelic');
const queue = require('kue').createQueue();

/*
 * @return Promise
 */
function aLongBgJob() {
  ...
}

const TRAN_NAME = 'example';
queue.process(TRAN_NAME, (job, done) => {
  const wrapedJob = newrelic.createBackgroundTransaction(TRAN_NAME, aLongBgJob);
  aLongBgJob(job.data)
  .then(function(result) {
    newrelic.endTransaction()ï¼›
    done();
  })
  .catch(function(error) {
    newrelic.noticeError(error)ï¼›
    newrelic.endTransaction()ï¼›
    done();
  })ï¼›
})
```

å½“ç„¶äº†ï¼Œæœ€å¥½æ˜¯é’ˆå¯¹è¿™äº›ä»»åŠ¡é˜Ÿåˆ—æ¡†æ¶åšä¸ªä¸­é—´ä»¶ wrap é€‚é…ï¼Œç»Ÿä¸€å¤„ç†ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ã€‚

å¦å¤–ï¼Œåƒä¸‡è®°å¾—ä¸å¯ä»¥è¿™æ ·ï¼š

```js
aLongBgJob = newrelic.createBackgroundTransaction(TRAN_NAME, aLongBgJob);
```

è¿™æ ·åšçš„è¯ï¼ŒaLongBgJob ä¼šè¢«åå¤ wrap ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°å¤šçš„è¯ï¼Œç›¸å½“äºè¢«åŒ…è£…äº†å¾ˆå¤šæ¬¡ï¼Œäºæ˜¯ä¼šå¯¼è‡´è°ƒç”¨æ ˆæº¢å‡ºï¼Œæœ€åæ‹–å®æ•´ä¸ªåº”ç”¨ï¼Œåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ğŸ™ˆã€‚

å…¶å®ƒä¸¤å®¶çš„æ²¡æ‰¾åˆ°æ–‡æ¡£ï¼Œä»£ç é‡Œé¢ä¼¼ä¹ä¹Ÿä¸æ˜æ˜¾ã€‚

### Reference
1. http://www.infoq.com/cn/articles/depth-2016-overview-of-apm
2. http://www.infoq.com/cn/articles/tingyun-cto-interview
3. http://www.infoq.com/cn/articles/oneapm-hexiaoyang-interview



***
åŸé“¾æ¥: https://github.com/xizhibei/blog/issues/40

![çŸ¥è¯†å…±äº«è®¸å¯åè®®](https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png "ç½²å - éå•†ä¸šæ€§ä½¿ç”¨ - ç›¸åŒæ–¹å¼å…±äº«ï¼ˆBY-NC-SAï¼‰")

æœ¬æ–‡é‡‡ç”¨ [ç½²å - éå•†ä¸šæ€§ä½¿ç”¨ - ç›¸åŒæ–¹å¼å…±äº«ï¼ˆBY-NC-SAï¼‰](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh) è¿›è¡Œè®¸å¯ã€‚
